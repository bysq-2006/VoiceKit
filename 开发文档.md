# 语音助手 - 开发文档

> 本文档用于理解项目架构，同时作为 AI 开发基准提示词。项目开发遵循非必要不添加，不要因为不存在的需求而多开发代码。写的代码要精简，简洁。

## 项目概述

一个基于 Tauri + Vue3 的桌面语音助手应用，核心设计理念：**状态驱动**——前端只修改状态变量，后端监听状态变化并执行对应工作流。

## 核心原则

```
┌─────────────────────────────────────────────────────────┐
│  前端 (Frontend)                                         │
│  ├── 仅负责 UI 渲染                                      │
│  ├── 仅负责修改状态变量                                  │
│  └── 通过 invoke 修改状态，通过 event 监听后端状态       │
├─────────────────────────────────────────────────────────┤
│  后端 (Backend)                                          │
│  ├── 监听状态变化，自动执行工作流                        │
│  ├── 管理音频缓冲区                                      │
│  ├── 管理文字缓冲区                                      │
│  ├── 调用语音转文字 API（双向流）                        │
│  ├── 模拟键盘输入到当前焦点                              │
│  └── 管理配置存储 (Store)                                │
└─────────────────────────────────────────────────────────┘
```


## 状态流转

```
用户按下快捷键 (如 Shift+E)
        ↓
后端: Global Shortcut Handler 触发
        ↓
前端: 修改 is_recording = true (invoke)
        ↓
后端: StateMonitor 监听到变化
        ↓
后端: AudioRecorder 开始 → 写入 AudioBuffer
        ↓
后端: ASRClient 开始 → 读取 AudioBuffer → 豆包 ASR
        ↓
后端: 豆包 ASR 返回文字 → 写入 TextBuffer
        ↓
后端: InputSimulator 读取 TextBuffer → 模拟键盘输入
        ↓
用户再次按下快捷键
        ↓
前端: 修改 is_recording = false (invoke)
        ↓
后端: StateMonitor 监听到变化
        ↓
后端: AudioRecorder 停止 → AudioBuffer 标记结束
        ↓
后端: ASRClient 处理完剩余音频 → TextBuffer 标记结束
        ↓
后端: InputSimulator 输出完剩余文字 → 停止
```


## 后端
### 核心储存
- src-tauri\src\models 里面存储结构体的定义
  - 最基础的状态，是否是否正在语音转文字
  - Config绑定在State下面，储存快捷键和API密钥。
  - 一个缓存区，存储录音的数据到一个队列里面，和豆包ASR交通的web socket从这个队列里面取出来音频数据块，然后发送过去自己同时又有一个文本队列，豆包发送的语音数据放到这个文本队列里面，然后键盘模拟输入就从这个文本队列里面取数据。
  - config详细：
        ```json
        {
        "shortcut": "Shift+E",
        "auto_start": false,
        "asr": {
        "provider": "xunfei",
        "doubao": {
        "api_key": "豆包-api-key"
        },
        "xunfei": {
        "app_id": "讯飞-app-id",
        "api_key": "讯飞-api-key",
        "api_secret": "讯飞-api-secret"
        }
        }
        }
        ```
        **配置结构**:
        - `shortcut`: 全局快捷键，默认 `"Shift+E"`
        - `auto_start`: 开机自启，默认 `false`
        - `asr.provider`: 当前使用的 ASR 服务商: `"doubao"` 或 `"xunfei"`
        - `asr.doubao.api_key`: 豆包 API 密钥
        - `asr.xunfei.app_id`: 讯飞应用 ID
        - `asr.xunfei.api_key`: 讯飞 API Key
        - `asr.xunfei.api_secret`: 讯飞 API Secret

### 录音
- src-tauri\src\workflow\recorder.rs 里面有一个其他线程的循环，会时刻检查的状态。
  - 每次进入录音状态时，先清空缓存区里面的音频数据
  - 然后开始时刻录音并且把得到的数据往缓存区丢
  - 录音的原因，数据可能是双声道四千赫兹之类的数据，会在里面将其转为单声道16K赫兹之类的数据在存入队列
  - 检测到状态转为false的时候只会停止录音。丢数据并不会清空缓存（asr可能还要用）

### ASR 模块
- **文件**: `src-tauri/src/asr/` 目录下
  - `manager.rs`: ASR 管理器，监控录音状态，启动/停止 ASR 会话
  - `xunfei.rs`: 讯飞 ASR 实现，WebSocket 双向流通信
  - `doubao.rs`: 豆包 ASR 实现（备用）
- **讯飞 ASR 工作流程**:
  - 建立 WebSocket 连接，HMAC-SHA256 鉴权
  - 从 AudioBuffer 读取音频（100ms/帧 @ 16kHz）
  - 首帧带参数（status=0），中间帧纯音频（status=1），结束帧空数据（status=2）
  - 接收服务端返回的识别结果，计算增量实时写入 TextBuffer
  - 讯飞限制：单句会话，识别完成后自动断开，需新建会话继续识别
- **调试功能**: AudioBuffer 支持统计信息（队列长度、振幅、写入/读取计数）和导出 PCM 文件

### 模拟输入
- **文件**: `src-tauri/src/workflow/input_simulator.rs`
- **功能**: 持续从 TextBuffer 读取文字并模拟键盘输入（队列驱动，有数据立即输入）
- **原理**: 独立线程循环读取 TextBuffer → 有内容立即输入 → 无内容阻塞等待
- **正常流程**: ASR 模块将识别结果写入 TextBuffer，输入模拟器持续读取并模拟键盘输入
